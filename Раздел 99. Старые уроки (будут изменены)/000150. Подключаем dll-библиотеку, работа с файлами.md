Подключаем dll-библиотеку, работа с файлами||wmysterio|wmysterio|wmysterio@yandex.ru|/||Всем хай! Мы продолжаем делать наш браузер, и сегодня нам предстоит сделать Лог последних посещаемых сайтов. Для этого удобнее будет использовать специальную библиотеку классов, которая будет выполнять действия, связанных с Лог'ом. Создадим новый проект в диспетчере проектов. Для этого выделите текущий проект, **ПКМ -&gt; Добавить -&gt; Создать проект**:<br><!--IMG1--><a href="/_pu/2/24265069.png" class="ulightbox" target="_blank" title="Нажмите, для просмотра в полном размере..."><img alt="" src="/_pu/2/s24265069.jpg" /></a><!--IMG1--><br>В открывающимся окне выберите "Библиотека классов" и укажем ему имя **BrowserLib**:<br><!--IMG2--><img alt="" src="/_pu/2/07302869.png" /><!--IMG2--><br>Нажимает "**Ок**". Мы создали проект, который пока пустой и не содержит нужного функционала. Чтобы мы могли использовать эту библиотеку, мы должны сохранить её. Нажимаем на иконку дискеток:<br><!--IMG3--><a href="/_pu/2/43327562.png" class="ulightbox" target="_blank" title="Нажмите, для просмотра в полном размере..."><img alt="" src="/_pu/2/s43327562.jpg" /></a><!--IMG3--><br>Переименуем наш класс на более понятое название, например: **BrowserLog**. Чтобы это было быстрее, достаточно в окне проекта выделить наш класс и нажать клавишу <u>F2</u>, которая уже давно в ОС Windows является горячей клавишей "переименовать":<br><!--IMG4--><img alt="" src="/_pu/2/42212840.png" /><!--IMG4--><br>нажимаем мышью где-либо и у нас появится сообщение: "Идет переименование файла..."<br><!--IMG5--><a href="/_pu/2/63947792.png" class="ulightbox" target="_blank" title="Нажмите, для просмотра в полном размере..."><img alt="" src="/_pu/2/s63947792.jpg" /></a><!--IMG5--><br>Соглашаемся на эту процедуру и все ссылки на это имя класса будут переименованы во всём проекте. Теперь мы можем приступать к написанию этой dll-ки.<br><br>С чего начать? Ну раз класс, по-идеи, должен сохранять последние ссылки, то они должны где-то хранится. По-этому, как вариант, я предлагаю их хранить в файле, заодно и изучим работу с ними :)<br><br>Создадим в проекте библиотеки новый файл, для этого в <u>BrowserLib</u> нажимаем **ПКМ -&gt;Добавить-&gt;Создать элемен**т:<br><!--IMG6--><a href="/_pu/2/60434137.png" class="ulightbox" target="_blank" title="Нажмите, для просмотра в полном размере..."><img alt="" src="/_pu/2/s60434137.jpg" /></a><!--IMG6--><br>Более простой вариант - горячие клавиши <font color="#0000cd">CTRL</font>+<font color="#0000cd">SHIFT</font>+<font color="#0000cd">A</font>.<br>В появившемся окне, выбираем "**Текстовый файл**", указываем ему имя "**Log.txt**" и нажимаем "**Ок**":<br><!--IMG7--><a href="/_pu/2/43133982.png" class="ulightbox" target="_blank" title="Нажмите, для просмотра в полном размере..."><img alt="" src="/_pu/2/s43133982.jpg" /></a><!--IMG7--><br>Мы прикрепили файл к нашему проекту, но нужно сделать ещё одну манипуляцию - автоматически создаваемый файл при компиляции проекта. Для этого выберем созданный текстовый файл и нажмём свойства и укажем полю "Копировать в выходной каталог" применим пункт "Всегда копировать":<br><br><!--IMG8--><img alt="" src="/_pu/2/06149403.png" /><!--IMG8--><br>Сохраняем проект и переходим к редактированию кода библиотеки.<br><br>Чтобы работать с файлами, нам необходимо подключить библиотеку. Пишем:<br><table style="width: 100%; border-collapse: collapse;"><tbody><tr><td style="vertical-align: top; border-width: 1px; border-style: solid; border-color: rgb(0, 0, 205); letter-spacing: 0px; word-spacing: 0px;">using System.IO;<br></td></tr></tbody></table>Чтобы не геммороиться с созданием объектов этого класса, предлагаю сделать 2 статичных метода, которые будут записывать и читать файл. Начнём с записи в файл:<br>1) Создадим метод "<font color="#0000cd">AddMessage</font>", который будет добавлять запись в Лог:<table style="width: 100%; border-collapse: collapse;"><tbody><tr><td style="vertical-align: top; border-width: 1px; border-style: solid; border-color: rgb(0, 0, 205); letter-spacing: 0px; word-spacing: 0px;">public static void AddMessage( string Text ) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <font color="#006400">// Здесь будет код!</font><br>}<br></td></tr></tbody></table>Далее идёт непосредственно сам процесс записи. Структуру файла я предлагаю сделать такой:<table style="width: 100%; border-collapse: collapse;"><tbody><tr><td style="vertical-align: top; border-width: 1px; border-style: solid; border-color: rgb(0, 0, 205); letter-spacing: 0px; word-spacing: 0px;"><font color="#ff0000">ДАТА_СОЗДАНИЯ</font>**\|**<font color="#0000cd">ТЕКСТ</font><br></td></tr></tbody></table>Чтобы мы могли легко читать данные с файла я отделил текст и дату <u>сепаратором</u> "<font color="#0000cd">\|</font>". А сам процесс записи такой:<table style="width: 100%; border-collapse: collapse;"><tbody><tr><td style="vertical-align: top; border-width: 1px; border-style: solid; border-color: rgb(0, 0, 205); letter-spacing: 0px; word-spacing: 0px;">File.AppendAllText( "Log.txt", Text + "&#92;r&#92;n" );<br></td></tr></tbody></table>Вначале указывается путь к файлу. Так как как файл автоматически будет создаваться в директории с программой, то ничего лишнего сюда добавлять не понадобилось. После этого указывается строка, которая будет дописана в файл. Чтобы отделить строки, я добавил к тексту ещё и перенос строки <font color="#ff0000">**&#92;r&#92;n**</font>. <br><br><font color="#ff0000">ВАЖНО!</font> Символ "<font color="#ff0000">&#92;n</font>" в c# поддерживается частично и данном случаи он не будет переносить строки.<br><br>Чтобы записать ещё и дату, нужно воспользоваться структурой **DateTime**. Процесс получения текущей даты выглядит следующим образом:<table style="width: 100%; border-collapse: collapse;"><tbody><tr><td style="vertical-align: top; border-width: 1px; border-style: solid; border-color: rgb(0, 0, 205); letter-spacing: 0px; word-spacing: 0px;">DateTime.Today.ToShortDateString()<br></td></tr></tbody></table>Чтобы обезопасить себя от исключений и ошибок влепим этот код в блок try. Сама процедура будет содержать такой код:<table style="width: 100%; border-collapse: collapse;"><tbody><tr><td style="vertical-align: top; border-width: 1px; border-style: solid; border-color: rgb(0, 0, 205); letter-spacing: 0px; word-spacing: 0px;">try {<br>&nbsp;&nbsp;&nbsp; File.AppendAllText( "Log.txt", DateTime.Today.ToShortDateString() + "\|" + Text + "&#92;r&#92;n" );<br>} catch { return; }<br></td></tr></tbody></table>Таким образом, если каким-то макаром файл не удастся открыть, то процесс записи будет пропущен.<br><br>Процесс чтения.<br>Начнём с того, как написать метод? Прежде всего Есть метод,&nbsp; который возвращает массив строк и выглядит он таким образом:<table style="border-collapse:collapse;width:100%;"><tbody><tr><td>File.ReadAllLines( "Log.txt" );<br></td></tr></tbody></table>Таким образом можно сформировать такой статический метод:<table style="width: 100%; border-collapse: collapse;"><tbody><tr><td style="vertical-align: top; border-width: 1px; border-style: solid; border-color: rgb(0, 0, 205); letter-spacing: 0px; word-spacing: 0px;">public static string[] GetMessages() {<br>&nbsp;&nbsp; // Здесь будет процесс чтения<br>}<br></td></tr></tbody></table>Нужно также помнить, что если файла не существует, то программа вызовет исключение по данному поводу и приведёт к краху браузера, по этому этот код лучше заточить в блок <font color="#0000cd">try</font>. Весь метод будет віглядить так:<table style="width: 100%; border-collapse: collapse;"><tbody><tr><td style="vertical-align: top; border-width: 1px; border-style: solid; border-color: rgb(0, 0, 205); letter-spacing: 0px; word-spacing: 0px;">public static string[] GetMessages() {<br>&nbsp;&nbsp; try {<br>&nbsp;&nbsp; &nbsp;&nbsp; return File.ReadAllLines( "Log.txt" );<br>&nbsp;&nbsp; } catch { return null; }<br>&nbsp;&nbsp; return Lines;<br>}<br></td></tr></tbody></table>Если файл не удастся открыть, то метод возвратит <font color="#ff0000">null</font>. Компилируем нашу библиотеку (клавиша **<font color="#0000cd">F6</font>**) и сохраняем проект.<br><br>Нам осталось только применить нашу библиотеку и посмотреть работает ли она :)<br>Переходим в проект браузера и в обработчике событий кнопки добавим код:<table style="width: 100%; border-collapse: collapse;"><tbody><tr><td style="vertical-align: top; border-width: 1px; border-style: solid; border-color: rgb(0, 0, 205); letter-spacing: 0px; word-spacing: 0px;"><font color="#0000cd">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private void button1_Click( object sender, EventArgs e ) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; webBrowser1.Url = new Uri( textBox1.Text );</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <font color="#006400">BrowserLog.AddMessage( textBox1.Text );</font><br><font color="#0000cd">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; label1.Text = "";<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } catch {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; label1.Text = "Неверное имя ссылки!";<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</font><br></td></tr></tbody></table>Чтобы компилятор видел нашу процедуру, нам необходимо включить её в проект. Для этого переходим в **Управление проектом, Ссылки -&gt;ПКМ-&gt;Добавить ссылку**:<br><!--IMG9--><img alt="" src="/_pu/2/98741504.png" /><!--IMG9--><br>В открывающемся окне выбираем вкладку "**Проекты**"<br><!--IMG10--><a href="/_pu/2/27122640.png" class="ulightbox" target="_blank" title="Нажмите, для просмотра в полном размере..."><img alt="" src="/_pu/2/s27122640.jpg" /></a><!--IMG10--><br>Выбираем созданный ранее проект библиотеки и нажимаем "**Ок**". Теперь нам нужно подключить её программно:<table style="width: 100%; border-collapse: collapse;"><tbody><tr><td style="vertical-align: top; border-width: 1px; border-style: solid; border-color: rgb(0, 0, 205); letter-spacing: 0px; word-spacing: 0px;">using BrowserLib;<br></td></tr></tbody></table>Всё, можно делать тест! Я перешел по 4-м разным сайтам и открыт файл "Log.txt", который находился в папке "<font color="#0000cd">WebForm</font><font color="#006400">&#92;bin&#92;Debug</font>" и получил следующий результат:<br><!--IMG11--><a href="/_pu/2/44644833.png" class="ulightbox" target="_blank" title="Нажмите, для просмотра в полном размере..."><img alt="" src="/_pu/2/s44644833.jpg" /></a><!--IMG11--><br>Все ссылки успешно записались в Лог-файл!<br><br>Что-же, на этом пожалуй окончу урок. В следующем мы рассмотрим такие темы, как вызов другой формы из первой, компонент ListBox. Встретимся в новом уроке ;)<br>|1598|1|0|24265069`png`624`144`400`92\|07302869`png`275`191\|43327562`png`587`258`400`175\|42212840`png`199`77\|63947792`png`499`173`400`138\|60434137`png`833`162`400`77\|43133982`png`481`132`400`109\|06149403`png`303`135\|98741504`png`254`79\|27122640`png`473`223`399`188\|44644833`png`600`202`400`134\||podkljuchaem_dll_biblioteku|1392773268