Детальнее о ref, out и checked||wmysterio|wmysterio|wmysterio@yandex.ru|||Всем огромный привет! Мы продолжаем изучать C# и сегодня мы рассмотрим интересные темы, такие как "переполнение переменных" и некоторые возможности переменных. Начнём с непонятным на первый взгляд переполнением. Каждый тип данных имеет свой диапазон значений. Основные перечислены в этом <a href="/publ/tipy_dannykh_operacii_nad_nimi/35-1-0-160">уроке</a>(см. Диапазон значений). Если значение переменной будет вне диапазона, то это приведёт либо к ошибке приложения, либо к выводу некорректных данных. Для примера возьмём всеми любимый <font color="#0000cd">int</font>:<br><br>Диапазон этого типа от <font color="#ff0000">-2147483648</font> до <font color="#ff0000">2147483647</font>. Если представить переменную в виде бутылки, то это будет выглядеть так:<br><!--IMG2--><img alt="" src="/_pu/2/17171675.png" /><!--IMG2--><br><br>Когда мы указываем некое значение переменной, то её ёмкость увеличивается в зависимости от самого значения.<br>Например выражение:<br><div class="bbCodeBlock"><div class="bbCodeName" style="padding-left:5px;font-weight:bold;font-size:7pt">Код</div><div class="codeMessage" style="border:1px inset;max-height:200px;overflow:auto;height:expression(this.scrollHeight<5?this.style.height:scrollHeight>200?'200px':''+(this.scrollHeight+5)+'px');">int A = 0;</div></div>заполнит этот "бочонок" ровно до середины, так как он является центром диапазона:<br><!--IMG1--><a href="/_pu/2/25821863.png" class="ulightbox" target="_blank" title="Нажмите, для просмотра в полном размере..."><img alt="" src="/_pu/2/s25821863.jpg" /></a><!--IMG1--><br><br>При выполнении всяких операций над переменной, этот объём постоянно меняется. И существует вероятность, что переменная выйдет за пределы. Если значение слишком большое, то происходит "выливание" части значения. В шарпе обычно значение указывается на минимум, и прибавляется к нему остаток. Чтобы это продемонстрировать наглядно, напишем такой код:<br><div class="bbCodeBlock"><div class="bbCodeName" style="padding-left:5px;font-weight:bold;font-size:7pt">Код</div><div class="codeMessage" style="border:1px inset;max-height:200px;overflow:auto;height:expression(this.scrollHeight<5?this.style.height:scrollHeight>200?'200px':''+(this.scrollHeight+5)+'px');">using System;<br>using System.Collections.Generic;<br>using System.Linq;<br>using System.Text;<br><br>namespace ConsoleApplication1 {<br>&nbsp;&nbsp;&nbsp; class Program {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; static void Main( string[] args ) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int A = 2147483647;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; A *= 2;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine( A );<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.ReadKey();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; }<br>}</div></div>В результате мы получаем результат <font color="#ff0000">-2</font>. Каким образом получилось такое явно неправильное значение? Давайте считать! Максимальный диапазон чисел составляет 2147483647. Дальше уже считается переполнением. Делается само умножение на значение, получаем <font color="#ff0000">4294967294</font>. Так как это значение вне диапазона, то система забирает остаток от максимального значения: <font color="#ff0000"><font color="#000000">4294967294 - 2147483647 =</font> 2147483647</font>. Далее минимальный диапазон переменной прибавляет к результату вычитания, при этом отнимает единицу от мин. значения, чтобы значение "влезало" в диапазон: <font color="#ff0000">( -2147483648 - 1) + 2147483647 <font color="#000000">= -2147483649 + 2147483647 = </font>-2</font>. Все эти операции нужны для того, чтобы значение переменной соответствовало указанному ей типу. В противных случаях переменная будет занимать больший размер(в байтах, и даже в битах), чем требуется, что делает работу приложения нестабильным. Вот и вся арифметика.<br><br>Возникает вопрос: как избежать переполнения? Самый простой вариант - указывать другой тип данных, с большим диапазоном, к примеру: <font color="#0000cd">long</font>. Если такой вариант не устраивает, то можно воспользоваться конструкцией <font color="#0000cd">checked</font>. Она позволяет проверить результат операции над переменной. К примеру так:<br><div class="bbCodeBlock"><div class="bbCodeName" style="padding-left:5px;font-weight:bold;font-size:7pt">Код</div><div class="codeMessage" style="border:1px inset;max-height:200px;overflow:auto;height:expression(this.scrollHeight<5?this.style.height:scrollHeight>200?'200px':''+(this.scrollHeight+5)+'px');">A = checked( A *= 2 );</div></div>Если результат операции умножения выходит за диапазон, то возникает исключение. Этим можно восспользоваться! Заточим этот блок в try:<br><div class="bbCodeBlock"><div class="bbCodeName" style="padding-left:5px;font-weight:bold;font-size:7pt">Код</div><div class="codeMessage" style="border:1px inset;max-height:200px;overflow:auto;height:expression(this.scrollHeight<5?this.style.height:scrollHeight>200?'200px':''+(this.scrollHeight+5)+'px');">try {<br>&nbsp;&nbsp;&nbsp;&nbsp; A = checked( A *= 2 );<br>&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine( A );<br>} catch {<br>&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine( (long) A * 2);<br>}</div></div>Результат:<br><!--IMG3--><img alt="" src="/_pu/2/94563876.png" /><!--IMG3--><br><br>Далее по плану изучим <font color="#0000cd">out</font>. Он используется в функциях как выходной параметр. Сам параметр должен быть создан в коде, где вызывается функция, а описания параметра функции должно встречаться в её теле. Простой пример такой функции:<br><div class="bbCodeBlock"><div class="bbCodeName" style="padding-left:5px;font-weight:bold;font-size:7pt">Код</div><div class="codeMessage" style="border:1px inset;max-height:200px;overflow:auto;height:expression(this.scrollHeight<5?this.style.height:scrollHeight>200?'200px':''+(this.scrollHeight+5)+'px');">static void Plus( int Value, out int Result ) {<br>&nbsp;&nbsp;&nbsp;&nbsp; Result = Value += 50;<br>}</div></div>А в теле мейна пишем:<br><div class="bbCodeBlock"><div class="bbCodeName" style="padding-left:5px;font-weight:bold;font-size:7pt">Код</div><div class="codeMessage" style="border:1px inset;max-height:200px;overflow:auto;height:expression(this.scrollHeight<5?this.style.height:scrollHeight>200?'200px':''+(this.scrollHeight+5)+'px');">static void Main( string[] args ) {<br>&nbsp;&nbsp;&nbsp;&nbsp; int k;<br>&nbsp;&nbsp;&nbsp;&nbsp; Plus( 10, out k );<br>&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine( k );<br>&nbsp;&nbsp;&nbsp;&nbsp; Console.ReadKey();<br>}</div></div>Результат:<br><!--IMG4--><img alt="" src="/_pu/2/26918486.png" /><!--IMG4--><br><br>С примера видно, что в теле основной программы мы создали переменную <font color="#0000cd">k</font>. Мы не задавали ей никакого значения - за нас это сделала функция, которая реализовала это в теле. Результат записался в переменную <font color="#0000cd">k</font>, как выходной параметр.<br><br>На очереди у нас ещё одна интересная фича - передача ссылок на переменные. Когда мы передаём в функцию какое-то значение, то в функцию кидается её копия. К примеру возьмём такую функцию:<br><div class="bbCodeBlock"><div class="bbCodeName" style="padding-left:5px;font-weight:bold;font-size:7pt">Код</div><div class="codeMessage" style="border:1px inset;max-height:200px;overflow:auto;height:expression(this.scrollHeight<5?this.style.height:scrollHeight>200?'200px':''+(this.scrollHeight+5)+'px');">using System;<br>using System.Collections.Generic;<br>using System.Linq;<br>using System.Text;<br><br>namespace ConsoleApplication1 {<br>&nbsp;&nbsp;&nbsp; class Program {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; static void Main( string[] args ) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int A = 10;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Plus( A );<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.ReadKey();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; static void Plus( int A ) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; A += 50;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine( "Функция: значение А = {0}", A);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; }<br>}</div></div>Результат такой операции:<br><!--IMG5--><img alt="" src="/_pu/2/67794547.png" /><!--IMG5--><br>Давайте проверим, чему равно значение A:<br><div class="bbCodeBlock"><div class="bbCodeName" style="padding-left:5px;font-weight:bold;font-size:7pt">Код</div><div class="codeMessage" style="border:1px inset;max-height:200px;overflow:auto;height:expression(this.scrollHeight<5?this.style.height:scrollHeight>200?'200px':''+(this.scrollHeight+5)+'px');">using System;<br>using System.Collections.Generic;<br>using System.Linq;<br>using System.Text;<br><br>namespace ConsoleApplication1 {<br>&nbsp;&nbsp;&nbsp; class Program {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; static void Main( string[] args ) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int A = 10;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Plus( A );<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine( "Мейн: значение А = {0}", A );<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.ReadKey();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; static void Plus( int A ) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; A += 50;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine( "Функция: значение А = {0}", A);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; }<br>}</div></div>Проверяем нашу программу:<br><!--IMG6--><img alt="" src="/_pu/2/07989036.png" /><!--IMG6--><br><br>Как видим, в функцию передалась копия переменной, но есть одна фича, которая позволяет передавать переменную напрямую, используя ссылки, в c# известны как <font color="#0000cd">ref</font>. Добавим эту сточку в параметр функции, а также объявим при вызове функции:<br><div class="bbCodeBlock"><div class="bbCodeName" style="padding-left:5px;font-weight:bold;font-size:7pt">Код</div><div class="codeMessage" style="border:1px inset;max-height:200px;overflow:auto;height:expression(this.scrollHeight<5?this.style.height:scrollHeight>200?'200px':''+(this.scrollHeight+5)+'px');">using System;<br>using System.Collections.Generic;<br>using System.Linq;<br>using System.Text;<br><br>namespace ConsoleApplication1 {<br>&nbsp;&nbsp;&nbsp; class Program {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; static void Main( string[] args ) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int A = 10;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Plus( <font color="#0000cd">ref</font> A );<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine( "Мейн: значение А = {0}", A );<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.ReadKey();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; static void Plus( <font color="#0000cd">ref</font> int A ) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; A += 50;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine( "Функция: значение А = {0}", A);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; }<br>}</div></div>Результат:<br><!--IMG7--><img alt="" src="/_pu/2/70049643.png" /><!--IMG7--><br><br>Таким образом мы можем динамически изменять значение переменных. Это также увеличивает скорость работы программы, так как она не создаёт копию параметров. <br><br>Надеюсь, этот урок был полезен для Вас. Это был мистерио, пока.<br>|771|1|0|25821863`png`672`478`400`284\|17171675`png`380`334\|94563876`png`166`95\|26918486`png`159`82\|67794547`png`253`98\|07989036`png`241`104\|70049643`png`250`92\||detalnee_o_ref_out_i_checked|1399127593