Очень длинные миссии в main.scm||wmysterio|wmysterio|wmysterio@yandex.ru|||Всем привет! Мы возвращаемся к кодингу MAIN.SCM, и в этом уроке разговор пойдёт об очень длинных миссиях. Случается так, что задание выходит очень длинным для прохождения и часто игроку не удаётся долго пройти миссию из за её длины и сложности. Логично было бы разбить миссию на некоторые этапы прохождения, вместо того, чтобы писать несколько миссий (в пределах её размера). Сегодня я покажу пример такой миссии. <br><br>Для реализации такой модели, нам будет нужна глобальная переменная, которая будет разбивать миссию на этапы. Допустим, эта переменная будет называться <font color="#0000cd">$MISSION_CJ_STAGE</font>, которая изначально будет равна нулю. Я начинаю писать код в новом мейне, по-этому скрипт у меня такой:<br> <div class="bbCodeBlock"><div class="bbCodeName" style="padding-left:5px;font-weight:bold;font-size:7pt"><font class="code">Код</font></div><div class="codeMessage" style="border:1px inset;max-height:200px;overflow:auto;height:expression(this.scrollHeight<5?this.style.height:scrollHeight>200?'200px':''+(this.scrollHeight+5)+'px');">DEFINE OBJECTS 0<br><br>DEFINE MISSIONS 1<br>DEFINE MISSION 0 AT @LONG_MISSION<br><br>DEFINE EXTERNAL_SCRIPTS 0<br><br>DEFINE UNKNOWN_EMPTY_SEGMENT 0<br><br>DEFINE UNKNOWN_THREADS_MEMORY 2048<br><br>//-------------MAIN---------------<br><br>:MAIN<br>thread 'MAIN' <br>fade 0 0&nbsp; <br>01F0: set_max_wanted_level_to 6 <br>00C0: set_current_time_hours_to 8 minutes_to 0 <br>04E4: unknown_refresh_game_renderer_at 2491.1572 -1670.3434<br>Camera.SetAtPos(2491.1572, -1670.3434, 12.3359)<br>$PLAYER_CHAR = Player.Create(#NULL, 2491.1572, -1670.3434, 12.3359)<br>$PLAYER_ACTOR = Actor.EmulateFromPlayer($PLAYER_CHAR)<br>Actor.Angle($PLAYER_ACTOR) = 66.3548<br>07AF: $PLAYER_GROUP = player $PLAYER_CHAR group<br>Camera.SetBehindPlayer<br>Player.SetClothes($PLAYER_CHAR, "WORKTRCAMOGRN", "WORKTR", 2)<br>Player.SetClothes($PLAYER_CHAR, "SNEAKERBINCGANG", "SNEAKER", 3)<br>Player.SetClothes($PLAYER_CHAR, "TSHIRTERISORN", "TSHIRT", 0)<br>Player.Build($PLAYER_CHAR)<br>Player.CanMove($PLAYER_CHAR) = True <br>0180: set_on_mission_flag_to $ONMISSION<br>fade 1 1000<br>wait 1000<br>016C: restart_if_wasted_at 2027.77 -1420.52 15.99 angle 137.0 town_number 0 <br>016C: restart_if_wasted_at 1180.85 -1325.57 12.58 angle 271.4 town_number 0 <br>016D: restart_if_busted_at 1550.68 -1675.49 14.51 angle 90.0 town_number 0 <br>016C: restart_if_wasted_at 1244.437 331.2261 18.5547 angle 7.5465 town_number 1 <br>016D: restart_if_busted_at 632.2344 -571.7104 15.3515 angle 267.2 town_number 1 <br>016C: restart_if_wasted_at -2199.719 -2308.075 29.6181 angle 322.8928 town_number 1 <br>016D: restart_if_busted_at -2163.829 -2387.817 29.625 angle 134.2066 town_number 1 <br>016C: restart_if_wasted_at -2670.285 616.4364 13.4531 angle 183.1042 town_number 1 <br>016D: restart_if_busted_at -1605.792 716.8598 11.0241 angle 355.2978 town_number 1 <br>016C: restart_if_wasted_at -316.3832 1056.045 18.7344 angle 1.6017 town_number 2 <br>016D: restart_if_busted_at -212.1889 979.4168 18.3219 angle 278.0478 town_number 2 <br>016C: restart_if_wasted_at -1514.823 2527.119 54.7443 angle 2.3546 town_number 2 <br>016D: restart_if_busted_at -1393.072 2633.116 54.9491 angle 86.0424 town_number 2 <br>016C: restart_if_wasted_at 1578.446 1770.682 9.8358 angle 99.7567 town_number 2 <br>016D: restart_if_busted_at 2337.083 2453.802 13.9765 angle 90.7643 town_number 2 <br>create_thread @SAVE<br>// Параметры запуска стартера<br>$POS_MIS_X_CJ = 2515.5813<br>$POS_MIS_Y_CJ = -1671.6604<br>$POS_MIS_Z_CJ = 13.7364<br>$MISSION_CJ_TOTAL = 0<br>$MISSION_CJ_STAGE = 0 // Текущий этам миссии<br>create_thread @STARTER<br>end_thread<br><br>:SAVE<br>thread 'SAVE'<br><br>while true<br>wait 0<br>&nbsp;&nbsp;&nbsp; if<br>&nbsp;&nbsp;&nbsp; 0AB0:&nbsp;&nbsp; key_pressed 115 // F4<br>&nbsp;&nbsp;&nbsp; then<br>&nbsp;&nbsp;&nbsp; 03D8: show_save_screen<br>&nbsp;&nbsp;&nbsp; wait 250<br>&nbsp;&nbsp;&nbsp; end<br>end<br><br><br>:STARTER<br>thread 'STARTER'<br>wait 0<br>$ICON_MIS_CJ = marker.CreateIconAndSphere(15, $POS_MIS_X_CJ, $POS_MIS_Y_CJ, $POS_MIS_Z_CJ)<br><br>:STARTER_A<br>wait 0<br>if AND<br>$ONMISSION == 0<br>$MISSION_CJ_TOTAL == 0<br>00EC:&nbsp;&nbsp; actor $PLAYER_ACTOR 0 near_point $POS_MIS_X_CJ $POS_MIS_Y_CJ radius 2.0 2.0<br>then<br>Player.CanMove($PLAYER_CHAR) = false<br>Actor.SetImmunities($PLAYER_ACTOR, 1, 1, 1, 1, 1)<br>0ACF: show_formatted_styled_text "Long mission" time 5000 style 2<br>fade 0 1000<br>wait 1000<br>start_mission 0<br>jump @STARTER_END<br>end<br>jump @STARTER_A<br><br>:STARTER_END<br>marker.Disable($ICON_MIS_CJ)<br>end_thread<br><br><br>//-------------Mission 0---------------<br>// Originally: MISSION_0<br><br>:LONG_MISSION<br>thread 'LONG_MISSION'<br>gosub @LONG_MISSION_29_57<br>if<br>wasted_or_busted<br>jf @LONG_MISSION_29_46<br>gosub @LONG_MISSION_29_144<br><br>:LONG_MISSION_29_46<br>$ONMISSION = 0<br>mission_cleanup<br>end_thread<br><br>:LONG_MISSION_29_57<br>increment_mission_attempts<br>$ONMISSION = 1<br><br>// ЗДЕСЬ БУДЕТ КОД НАШЕЙ МИССИИ!!!<br><br>gosub @LONG_MISSION_END<br>01E3: show_text_1number_styled GXT 'M_PASS' number 20000 time 5000 style 1&nbsp; <br>Player.Money($PLAYER_CHAR) += 20000<br>0394: play_music 1 <br>return<br><br>:LONG_MISSION_29_144<br>wait 0<br>gosub @LONG_MISSION_END<br>create_thread @STARTER<br>00BA: show_text_styled GXT 'M_FAIL' time 5000 style 1<br>return<br><br>:LONG_MISSION_END<br>wait 0<br>return<font class="code"></font></div></div> Вооружившись моей <a href="/load/gta_sa/programmy/sb_visual_jumptables_generator/69-1-0-659">программой</a>, создадим таблицу переходов, которая будет определять этапы прохождения. В качестве переменной выбора мы указываем наш флаг этапа а в метке выхода - название потока миссии. Думаю, 5 этапов будет достаточно для примера, по-этому оставим обычные пробелы в 5 первых полях, чтобы сгенерировать код:<br><!--IMG2--><a href="/_pu/2/05219952.png" class="ulightbox" target="_blank" title="Нажмите, для просмотра в полном размере..."><img alt="" src="/_pu/2/s05219952.jpg" /></a><!--IMG2--><br>В результате у нас получится примерно вот такая таблица:<br> <div class="bbCodeBlock"><div class="bbCodeName" style="padding-left:5px;font-weight:bold;font-size:7pt"><font class="code">Код</font></div><div class="codeMessage" style="border:1px inset;max-height:200px;overflow:auto;height:expression(this.scrollHeight<5?this.style.height:scrollHeight>200?'200px':''+(this.scrollHeight+5)+'px');">// Определите переменную $MISSION_CJ_STAGE по которой будет осуществлятся выбор.<br>// Диапазон этой переменной должен быть от 0 до 4 и типа INTEGER.<br><br>0871: init_jump_table $MISSION_CJ_STAGE total_jumps 6 default_jump 0 @LONG_MISSION_1663_EXIT jumps 0 @LONG_MISSION_1663_0 1 @LONG_MISSION_1663_1 2 @LONG_MISSION_1663_2 3 @LONG_MISSION_1663_3 4 @LONG_MISSION_1663_4 -1 @LONG_MISSION_1663_EXIT -1 @LONG_MISSION_1663_EXIT<br><br>:LONG_MISSION_1663_0 // будет выполнятся этот участок кода, если переменная $MISSION_CJ_STAGE будет равна 0<br>&nbsp;<br>jump @LONG_MISSION_1663_EXIT<br><br>:LONG_MISSION_1663_1 // будет выполнятся этот участок кода, если переменная $MISSION_CJ_STAGE будет равна 1<br>&nbsp;<br>jump @LONG_MISSION_1663_EXIT<br><br>:LONG_MISSION_1663_2 // будет выполнятся этот участок кода, если переменная $MISSION_CJ_STAGE будет равна 2<br>&nbsp; <br>jump @LONG_MISSION_1663_EXIT<br><br>:LONG_MISSION_1663_3 // будет выполнятся этот участок кода, если переменная $MISSION_CJ_STAGE будет равна 3<br>&nbsp;<br>jump @LONG_MISSION_1663_EXIT<br><br>:LONG_MISSION_1663_4 // будет выполнятся этот участок кода, если переменная $MISSION_CJ_STAGE будет равна 4<br>&nbsp;<br>jump @LONG_MISSION_1663_EXIT<br><br>:LONG_MISSION_1663_EXIT<br><br>// Продолжайте ваш код ...</div></div> Убираем все метки из этого участка кода, кроме метки выхода, и копируем код в скрипт миссии, перед gosub'ом на метку очищения памяти от объектов миссии:<br> <div class="bbCodeBlock"><div class="bbCodeName" style="padding-left:5px;font-weight:bold;font-size:7pt"><font class="code">Код</font></div><div class="codeMessage" style="border:1px inset;max-height:200px;overflow:auto;height:expression(this.scrollHeight<5?this.style.height:scrollHeight>200?'200px':''+(this.scrollHeight+5)+'px');">:LONG_MISSION_29_57<br>increment_mission_attempts<br>$ONMISSION = 1<br><br>0871: init_jump_table $MISSION_CJ_STAGE total_jumps 6 default_jump 0 @LONG_MISSION_1663_EXIT jumps 0 @LONG_MISSION_1663_0 1 @LONG_MISSION_1663_1 2 @LONG_MISSION_1663_2 3 @LONG_MISSION_1663_3 4 @LONG_MISSION_1663_4 -1 @LONG_MISSION_1663_EXIT -1 @LONG_MISSION_1663_EXIT <br><br>:LONG_MISSION_1663_0 // Когда $MISSION_CJ_STAGE == 0<br><br>:LONG_MISSION_1663_1 // Когда $MISSION_CJ_STAGE == 1<br><br>:LONG_MISSION_1663_2 // Когда $MISSION_CJ_STAGE == 2<br><br>:LONG_MISSION_1663_3 // Когда $MISSION_CJ_STAGE == 3<br><br>:LONG_MISSION_1663_4 // Когда $MISSION_CJ_STAGE == 4<br><br>:LONG_MISSION_1663_EXIT<br><br>// Продолжаем код...<br><br>gosub @LONG_MISSION_END<br>01E3: show_text_1number_styled GXT 'M_PASS' number 20000 time 5000 style 1&nbsp; <br>Player.Money($PLAYER_CHAR) += 20000<br>0394: play_music 1 <br>return</div></div> Таким образом, в зависимости от значения переменной $MISSION_CJ_STAGE скрипт будет переходить между этапами. После прохождения определённого этапа, мы должны увеличить его флаг на единицу:<br> <div class="bbCodeBlock"><div class="bbCodeName" style="padding-left:5px;font-weight:bold;font-size:7pt"><font class="code">Код</font></div><div class="codeMessage" style="border:1px inset;max-height:200px;overflow:auto;height:expression(this.scrollHeight<5?this.style.height:scrollHeight>200?'200px':''+(this.scrollHeight+5)+'px');">:LONG_MISSION_1663_0 <br>wait 1000<br>&nbsp;&nbsp;&nbsp; // Код для 1 этапа<br>fade 0 1000<br>$MISSION_CJ_STAGE += 1<br><br>:LONG_MISSION_1663_1 <br>wait 1000 <br>&nbsp;&nbsp;&nbsp; // Код для 2 этапа<br>fade 0 1000<br>$MISSION_CJ_STAGE += 1<br><br>:LONG_MISSION_1663_2 &nbsp;<br>wait 1000<br>&nbsp;&nbsp;&nbsp; // Код для 3 этапа<br>fade 0 1000<br>$MISSION_CJ_STAGE += 1<br><br>:LONG_MISSION_1663_3 &nbsp;<br>wait 1000 <br>&nbsp;&nbsp;&nbsp; // Код для 4 этапа<br>fade 0 1000<br>$MISSION_CJ_STAGE += 1<br><br>:LONG_MISSION_1663_4 &nbsp;<br>wait 1000<br>&nbsp;&nbsp;&nbsp; // Код для 5 этапа<br>fade 0 1000<br>$MISSION_CJ_STAGE += 1<br><br>:LONG_MISSION_1663_EXIT<br></div></div> Получается, что когда игрок начинает миссию после провала, таблица переходов определяет место продолжения миссии. Это напоминает "точку сохранения (она же контрольная точка)" из других игр. Схематически такую систему можно изобразить следующим образом:<br><!--IMG3--><a href="/_pu/2/93392058.png" class="ulightbox" target="_blank" title="Нажмите, для просмотра в полном размере..."><img alt="" src="/_pu/2/s93392058.jpg" /></a><!--IMG3--><br><br>Также нужно учесть, что в последнем этапе мы должны очистить флаг этапа, чтобы следующая миссия в стартере начинала свой сюжет с первого этапа а также нужно увеличить счётчик стартера:<br> <div class="bbCodeBlock"><div class="bbCodeName" style="padding-left:5px;font-weight:bold;font-size:7pt"><font class="code">Код</font></div><div class="codeMessage" style="border:1px inset;max-height:200px;overflow:auto;height:expression(this.scrollHeight<5?this.style.height:scrollHeight>200?'200px':''+(this.scrollHeight+5)+'px');">:LONG_MISSION_1663_4&nbsp; <br>wait 1000<br>&nbsp;&nbsp;&nbsp; // Код для 5 этапа<br>fade 0 1000<br>$MISSION_CJ_STAGE = 0<br>$MISSION_CJ_TOTAL += 1<br><br>:LONG_MISSION_1663_EXIT<br></div></div> Я не стану делать сейчас сложную в прохождении миссию, по-этому ограничусь несколькими условиями. Первый этап начнётся видеороликом, в котором Свит разговаривает с CJ. Допустим, они собирались пострелять по бутылкам:<br> <div class="bbCodeBlock"><div class="bbCodeName" style="padding-left:5px;font-weight:bold;font-size:7pt"><font class="code">Код</font></div><div class="codeMessage" style="border:1px inset;max-height:200px;overflow:auto;height:expression(this.scrollHeight<5?this.style.height:scrollHeight>200?'200px':''+(this.scrollHeight+5)+'px');">:LONG_MISSION_1663_0 <br>01EB: set_traffic_density_multiplier_to 0.0<br>03DE: set_pedestrians_density_multiplier_to 0.0<br>0395: clear_area 0 at 2527.4084 -1666.8297 14.1683 radius 3.0<br>Actor.PutAt($PLAYER_ACTOR, 2527.4084, -1666.8297, 14.1683)<br>Actor.Angle($PLAYER_ACTOR) = 179.7592<br>023C: load_special_actor 'SWEET' as 1<br><br>repeat<br>wait 0<br>until 023D:&nbsp;&nbsp; special_actor 1 loaded<br><br>// создаём Свита, относительно CJ'я<br>04C4: store_coords_to 0@ 1@ 2@ from_actor $PLAYER_ACTOR with_offset 0.0 1.0 -1.0<br>3@ = Actor.Angle($PLAYER_ACTOR)<br>3@ += 180.0<br>$SWEET_ACTOR = Actor.Create(7, #SPECIAL01, 0@, 1@, 2@)<br>Actor.Angle($SWEET_ACTOR) = 3@<br>0296: unload_special_actor 1<br>Actor.SetImmunities($SWEET_ACTOR, 1, 1, 1, 1, 1)<br>// получаем координаты позиции камеры и её поинта относительно CJ'я <br>04C4: store_coords_to 0@ 1@ 2@ from_actor $PLAYER_ACTOR with_offset 3.0 0.5 0.0<br>04C4: store_coords_to 3@ 4@ 5@ from_actor $PLAYER_ACTOR with_offset 0.0 0.5 0.0<br>Camera.SetPosition(0@, 1@, 2@, 0.0, 0.0, 0.0)<br>0160: set_camera_point_at 3@ 4@ 5@ switchstyle 2<br></div></div> Т<br><br><br><br><br><br><br><br>|12|1|0|\|05219952`png`754`504`400`267\|93392058`png`1310`624`400`190\||ochen_dlinnye_missii_v_main_scm|1403157306